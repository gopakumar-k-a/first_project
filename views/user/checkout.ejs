<%- include('header.ejs') %>
    <!-- Begin Li's Breadcrumb Area -->
    <div class="breadcrumb-area">
        <div class="container">
            <div class="breadcrumb-content">
                <ul>
                    <li><a href="/">Home</a></li>
                    <li class="active">Checkout</li>
                </ul>
            </div>
        </div>
    </div>
    <!-- Li's Breadcrumb Area End Here -->
    <!--Checkout Area Strat-->

    <% if (cartData && cartData!=null) { %>
        <% if (typeof cartData==='object' && cartData !==null && Array.isArray(cartData.products) &&
            cartData.products.length> 0) { %>
            <div class="checkout-area pt-60 pb-30">
                <div class="container">
                    <div class="row">
                        <div class="col-12">
                            <div class="coupon-accordion">
                                <!--Accordion Start-->
                                <!-- <h3>Returning customer? <span id="showlogin">Click here to login</span></h3>
                                <div id="checkout-login" class="coupon-content">
                                    <div class="coupon-info">
                                        <p class="coupon-text">Quisque gravida turpis sit amet nulla posuere lacinia. Cras sed est sit amet ipsum luctus.</p>
                                        <form action="#">
                                            <p class="form-row-first">
                                                <label>Username or email <span class="required">*</span></label>
                                                <input type="text">
                                            </p>
                                            <p class="form-row-last">
                                                <label>Password  <span class="required">*</span></label>
                                                <input type="text">
                                            </p>
                                            <p class="form-row">
                                                <input value="Login" type="submit">
                                                <label>
                                                    <input type="checkbox">
                                                     Remember me 
                                                </label>
                                            </p>
                                            <p class="lost-password"><a href="#">Lost your password?</a></p>
                                        </form>
                                    </div>
                                </div> -->
                                <!--Accordion End-->
                                <!--Accordion Start-->
                                <%if(couponData && couponData.length>0){%>
                                    <div id="couponDataDiv">
                                        <h3>Your order is eligible for coupon apply <span id="showcoupon">Click here to
                                                get
                                                your coupon code</span></h3>
                                        <div id="checkout_coupon" class="coupon-checkout-content">
                                            <div class="coupon-info">
                                                <form action="#">
                                                    <p class="checkout-coupon">
                                                        <!-- <input placeholder="Coupon code" type="text">
                                                    <input value="Apply Coupon" type="submit"> -->
                                                    <h4>apply any one of the code before order to claim the offer</h4>
                                                    <div
                                                        style="width: 500px; margin: 0 auto; padding: 20px; display: flex; background-color: #f5f5f5;">
                                                        <table
                                                            style="border-collapse: collapse; width: 100%; border: none; margin-left: auto;">
                                                            <thead>
                                                                <tr>
                                                                    <th></th>
                                                                    <th></th>
                                                                    <th></th>
                                                                    <th></th>
                                                                </tr>
                                                            </thead>
                                                            <tbody>
                                                                <% couponData.forEach((coupon, index)=> { %>
                                                                    <tr>
                                                                        <td style="border: none; padding: 10px 20px;">
                                                                            <!-- <button
                                                                            onclick="copyToClipboard('couponName<%= index %>')">Copy</button> -->
                                                                            <sl-copy-button id="copyButton"
                                                                                value="<%=coupon.name%>"></sl-copy-button>

                                                                        </td>
                                                                        <td style="border: none; padding: 10px 20px;">
                                                                            <h4 id="couponName<%= index %>">
                                                                                <%= coupon.name %>
                                                                            </h4>


                                                                        </td>
                                                                        <td style="border: none; padding: 10px 20px;">
                                                                            <% if (coupon.flatOffer> 0) { %>
                                                                                flat &#8377;<%= coupon.flatOffer %> off
                                                                                    <% } else { %>
                                                                                        flat <%= coupon.discountPercent
                                                                                            %>%
                                                                                            off
                                                                                            <% } %>
                                                                        </td>
                                                                        <td style="border: none; padding: 10px 20px;">
                                                                            on minimum purchase of &#8377;<%=
                                                                                coupon.minimumPurchase %>
                                                                        </td>
                                                                    </tr>
                                                                    <% }) %>
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                    </p>


                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                    <%}%>


                                        <!--Accordion End-->
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-lg-6 col-12">
                            <div class="page-section mb-60">
                                <div class="container text-center">
                                    <div class="row d-flex">

                                        <div class="col-sm-12 col-md-12 col-lg-8 col-xs-12">
                                            <!-- Adjusted col-lg-6 to col-lg-8 for increased width -->
                                            <h4 class="login-title">Manage Address</h4>

                                            <div class="col-12 d-flex justify-content-start pt-3">

                                                <div class="container mt-5">
                                                    <button class="register-button mt-0 custom-width-button"
                                                        onclick="hello(event)" title="quick view" class="quick-view-btn"
                                                        data-toggle="modal" data-target="#exampleModalCenter">
                                                        Add New Address
                                                    </button>
                                                    <h3 class="mt-3">Addresses</h3>
                                                    <hr>

                                                    <!-- Loop through user addresses and display each one -->
                                                    <div class="row">

                                                        <% cartData.userId.address.forEach((address, index)=> { %>
                                                            <input type="radio" name="indexOfAddress"
                                                                class="radio-label" value="<%=index%>" <% if (index===0)
                                                                { %>checked<% } %>>


                                                                <div class="col-md-12 mb-3">

                                                                    <div class="card">
                                                                        <div class="card-body">

                                                                            <input type="text" value="<%= index %>"
                                                                                id="indexOfAddress" hidden>
                                                                            <h5 class="card-title">Address <%= index + 1
                                                                                    %>
                                                                            </h5>
                                                                            <p class="card-text">
                                                                                <%= address.firstName %>
                                                                                    <%= address.lastName %>,
                                                                                        <%= address.houseName %>, <%=
                                                                                                address.city %>,
                                                                                                <%= address.state %>,
                                                                                                    <%= address.landMark
                                                                                                        %>,
                                                                                                        <%= address.pincode
                                                                                                            %>
                                                                            </p>

                                                                            <p class="card-text"><strong>Phone:</strong>
                                                                                <%= address.phone %>
                                                                            </p>
                                                                            <p class="card-text"><strong>Alternate
                                                                                    Phone:</strong>
                                                                                <%= address.altPhone %>
                                                                            </p>
                                                                            <h6>
                                                                                <a class="product_name"
                                                                                    href="/edit-user-address?index=<%= index %>&from=checkout">edit</a>
                                                                                <span class="mx-2">|</span>
                                                                                <a class="product_name" href="#"
                                                                                    onclick="deleteAddress()">delete</a>
                                                                            </h6>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                                <% }); %>
                                                    </div>


                                                </div>
                                                <style>
                                                    input[type="radio"] {
                                                        width: 16px;
                                                        /* Set the width */
                                                        height: 16px;
                                                        /* Set the height */
                                                    }

                                                    /* Optionally, you can style the label for better appearance */
                                                    .radio-label {
                                                        display: inline-block;
                                                        padding: 5px 10px;
                                                        cursor: pointer;
                                                        border: 1px solid #ccc;
                                                        border-radius: 4px;
                                                        margin-right: 10px;
                                                    }

                                                    /* Style the radio button when selected */
                                                    input[type="radio"]:checked+label {
                                                        background-color: #007bff;
                                                        color: #fff;
                                                    }
                                                </style>

                                                <script>
                                                    // Function to open the edit modal
                                                    function openEditModal(index) {

                                                        var modalId = '#exampleModalEdit' + index;

                                                        // Trigger Bootstrap modal display
                                                        $(modalId).modal('show');
                                                    }




                                                    function hello(event) {
                                                        event.preventDefault();
                                                    }
                                                </script>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                        </div>
                        <div class="col-lg-6 col-12">
                            <div class="your-order">
                                <h3>Your order</h3>
                                <div class="your-order-table table-responsive">
                                    <table class="table">
                                        <thead>
                                            <tr>
                                                <th class="cart-product-name"></th>
                                                <th class="cart-product-name">Product</th>

                                                <th class="cart-product-total">Quantity</th>
                                                <th class="cart-product-total">Total</th>

                                            </tr>
                                        </thead>
                                        <tbody>
                                            <%if(cartData!=null){%>
                                                <!-- loop area -->
                                                <% for (let i=0; i < cartData.products.length; i++) { %>
                                                    <tr class="cart_item">
                                                        <td>
                                                            <img src="/admin-assets/uploads/<%= cartData.products[i].productId.imagesUrl[0] %>"
                                                                alt="product image" style="width: 80px; height: 80px;">
                                                        </td>

                                                        <td class="cart-product-name">
                                                            <%= cartData.products[i].productId.name %>



                                                        </td>


                                                        <td>
                                                            <strong class="product-quantity"> Ã— <%=
                                                                    cartData.products[i].quantity %>
                                                            </strong>
                                                            <input type="text"
                                                                value="<%= cartData.products[i].quantity%>"
                                                                id="quantity<%=i%>" hidden>
                                                        </td>
                                                        <td class="cart-product-total">
                                                            <span class="amount" id="totalProductPrice<%=i%>">
                                                                <input type="text"
                                                                    value="<%=cartData.products[i].productId.price.salePrice%>"
                                                                    id="unitPrice<%=i%>" hidden>

                                                            </span>
                                                            <input type="text" id="totalProductPriceHidden<%=i%>"
                                                                hidden>
                                                        </td>

                                                    </tr>
                                                    <% } %>
                                                        <%}%>

                                                            <!-- ------ -->
                                        </tbody>
                                        <script>
                                            document.addEventListener('DOMContentLoaded', function () {
                                                // Calculate and set the total product price for each item
                                                for (let i = 0; i < <%= cartData.products.length %>; i++) {
                                                const unitPrice = parseFloat(document.getElementById(`unitPrice${i}`).value);
                                                const quantity = parseInt(document.getElementById(`quantity${i}`).value, 10);
                                                const totalProductPrice = unitPrice * quantity;
                                                document.getElementById(`totalProductPrice${i}`).innerHTML = totalProductPrice.toFixed(2);
                                                document.getElementById(`totalProductPriceHidden${i}`).value = totalProductPrice.toFixed(2);
                                            }
                                })
                                        </script>
                                        <tfoot>
                                            <tr class="cart-subtotal">
                                                <th>Cart Subtotal</th>
                                                <td><span class="amount"></span></td>
                                                <td><span class="amount"></span></td>
                                                <td><span class="amount" id="subTotal"></span></td>
                                            </tr>

                                            <tr class="cart-subtotal" id="walletDiv" style="visibility: hidden;">
                                                <th>Wallet Amount</th>
                                                <td><span class="amount"></span></td>
                                                <td><span class="amount"></span></td>
                                                <td><span class="amount" id="walletBal">0</span></td>
                                            </tr>
                                            <!-- couponShow -->
                                            <tr class="cart-subtotal" id="couponAmountDiv" style="visibility: hidden;">
                                                <th>Coupon Amount</th>
                                                <td><span class="amount"></span></td>
                                                <td><span class="amount"></span></td>
                                                <td><span class="amount" id="couponAmount">0</span></td>
                                            </tr>
                                            <style>
                                                #couponAmount::before {
                                                    content: '-';
                                                }

                                                #walletBal::before {
                                                    content: '-';
                                                }
                                            </style>
                                            <!-- <tr class="cart-subtotal" style="display: block;" id="walletDiv">
                                                <th>Wallet Amount</th>
                                                <td><span class="amount"></span></td>
                                                <td><span class="amount"></span></td>
                                                <td><span class="amount" id="walletBal">0</span></td>
                                            </tr> -->


                                            <tr class="order-total">
                                                <th>Order Total</th>
                                                <td><span class="amount"></span></td>
                                                <td><span class="amount"></span></td>
                                                <td><strong><span class="amount" id="total"
                                                            name="orderTotal"></span></strong>
                                                </td>
                                            </tr>
                                            <%if(couponData && couponData.length>0){%>
                                                <tr class="order-total">
                                                    <td>
                                                        <div id="couponDiv">
                                                            <input style="background-color: white;"
                                                                placeholder="Coupon code" type="text" id="couponName">

                                                            <div class="order-button-payment">
                                                                <input value="apply coupon" type="button"
                                                                    id="couponButton">
                                                            </div>
                                                            <li class="text-danger" id="couponFieldError"></li>
                                                        </div>
                                                        <input type="text" id="currentCouponNameHidden">
                                                        <input type="text" id="currentCouponTypeHidden">
                                                        <input type="text" id="currentCouponValueHidden">


                                                    </td>
                                                </tr>
                                                <%}%>
                                        </tfoot>
                                    </table>
                                </div>

                                <script>
                                    //bill calculation


                                    document.addEventListener('DOMContentLoaded', function () {
                                        const addressErr = document.getElementById('addressErr')
                                        addressErr.style.display = 'none';
                                        var productPrice = 0;
                                        let subTotal = document.getElementById('subTotal');
                                        // let sub2Total = document.getElementById('sub2Total')
                                        let walletAmount = parseFloat(document.getElementById('walletBal'))
                                        let couoponAmount = parseFloat(document.getElementById('couoponAmount'))
                                        let total = document.getElementById('total')
                                        let totalRes = parseInt(document.getElementById('total').innerHTML)

                                        for (let i = 0; i < <%= cartData.products.length %>; i++) {
                                        let hiddenValue = document.getElementById(`totalProductPriceHidden${i}`).value;
                                        let parsedValue = parseFloat(hiddenValue);
                                        productPrice += parsedValue;

                                    }
                                    // sub2Total.innerHTML = productPrice.toFixed(2);
                                    let walletRes = walletAmount.toFixed(2)
                                    let couponRes = couoponAmount.toFixed(2)
                                    let subRes = productPrice.toFixed(2);
                                    subTotal.innerHTML = subRes
                                    if (walletAmount.innerHTML > 0 || couoponAmount.innerHTML > 0) {
                                        total.innerHTML = totalRes - walletRes - couponRes

                                    } else {

                                        total.innerHTML = productPrice.toFixed(2);
                                    }

                                    });


                                    //couponFetch

                                    // Variable to store the currently applied discount
                                    let currentDiscount = 0;

                                    function applyCoupon() {
                                        const couponName = document.getElementById('couponName').value.trim().toUpperCase();
                                        const couponFieldError = document.getElementById('couponFieldError');
                                        const couponAmount = document.getElementById('couponAmount');
                                        couponAmount.innerHTML = 0;

                                        if (couponName === '') {
                                            couponFieldError.innerHTML = 'Please enter a value before applying';
                                            return;
                                        }

                                        couponFieldError.innerHTML = '';

                                        // Disable the fetch button to prevent multiple clicks
                                        const fetchButton = document.getElementById("couponButton");
                                        fetchButton.disabled = true;

                                        const totalElement = document.getElementById('total');
                                        let totalVal = parseInt(totalElement.innerHTML);

                                        // Reset the applied coupon details before applying a new one
                                        resetCouponDetails();

                                        fetch(`/get-coupon-data?name=${couponName}&total=${totalVal}`, {
                                            method: 'GET',
                                            headers: {
                                                'Content-Type': 'application/json',
                                            }
                                        }).then(response => response.json())
                                            .then(data => {
                                                console.log('data in response', data);

                                                const message = data.message;
                                                const discountPrice = data.discountPrice;
                                                const couponType = data.couponType
                                                const discountValue = data.discountValue
                                                const couponName = data.couponName

                                                if (message === 'success') {

                                                    totalVal += currentDiscount;
                                                    const currentCouponNameHidden = document.getElementById('currentCouponNameHidden')
                                                    currentCouponNameHidden.value = couponName
                                                    const currentCouponTypeHidden = document.getElementById('currentCouponTypeHidden')
                                                    currentCouponTypeHidden.value = couponType
                                                    const currentCouponValueHidden=document.getElementById('currentCouponValueHidden')
                                                    currentCouponValueHidden.value=discountValue
                                                    if (couponType === 'flat') {
                                                        totalVal -= discountPrice;
                                                        currentDiscount = discountPrice;
                                                    } else if (couponType === 'percentage') {

                                                        const percentageDiscount = totalVal * (discountValue / 100);
                                                        totalVal -= parseInt(percentageDiscount);
                                                        currentDiscount = parseInt(percentageDiscount);
                                                    }

                                                    totalVal = Math.max(totalVal, 0);

                                                    totalElement.innerHTML = totalVal;
                                                    couponAmount.innerHTML = currentDiscount;


                                                    const couponAmountDiv = document.getElementById('couponAmountDiv');
                                                    couponAmountDiv.style.visibility = 'visible';
                                                } else if (message === 'cantApply') {
                                                    couponFieldError.innerHTML = 'Cannot apply coupon';
                                                } else if (message === 'notFound') {
                                                    couponFieldError.innerHTML = 'Cannot find coupon';
                                                }
                                            })
                                            .catch(error => {
                                                console.log('Error applying coupon:', error);
                                            })
                                            .finally(() => {
                                                // Enable the fetch button after the operation is complete
                                                fetchButton.disabled = false;
                                            });
                                    }

                                    document.getElementById("couponButton").addEventListener("click", applyCoupon);





                                    // Function to reset applied coupon details
                                    function resetCouponDetails() {
                                        const couponAmount = document.getElementById('couponAmount');
                                        const couponAmountDiv = document.getElementById('couponAmountDiv');
                                        couponAmount.innerHTML = 0;
                                        couponAmountDiv.style.visibility = 'hidden';
                                    }



                                    //walletFetch
                                    document.addEventListener('DOMContentLoaded', () => {
                                        const walletCheckbox = document.getElementById('walletCheckbox')
                                        walletCheckbox.addEventListener('change', () => {
                                            if (walletCheckbox.checked) {
                                                // fetchWalletBalance()

                                                const total = parseInt(document.getElementById('total').innerHTML)
                                                const couponAmount = parseInt(document.getElementById('couponAmount').innerHTML)
                                                let couponCheck = 0
                                                if (couponAmount > 0) {
                                                    couponCheck = couponAmount
                                                }


                                                fetch(`/get-wallet-data?total=${total}&couponCheck=${couponCheck}`, {
                                                    method: 'GET',
                                                    headers: {
                                                        'Content-Type': 'application/json',
                                                    },

                                                }).then(response => response.json())
                                                    .then(data => {
                                                        console.log(data);
                                                        //wallet balance
                                                        const walletBalance = data.walletBal
                                                        console.log('this is wallet  balance:walletBalance: ', walletBalance);
                                                        //for hiding wallet div
                                                        const walletDiv = document.getElementById('walletDiv')
                                                        //applied wallet value html
                                                        const walletBal = document.getElementById('walletBal')
                                                        //wallet balance under checkbox
                                                        const walletBalanceShow = document.getElementById('walletBalanceShow')
                                                        //availabel balance in the wallet
                                                        const walletBalanceShowVal = parseInt(walletBalanceShow.innerHTML)
                                                        //money required to apply
                                                        const moneyRequired = data.moneyRequired

                                                        walletDiv.style.visibility = 'visible'
                                                        let total = document.getElementById('total')
                                                        let totalVal = parseFloat(document.getElementById('total').innerHTML)

                                                        // const subTotalRes = parseFloat(subTotal.innerHTML)
                                                        console.log('this is total val :totalVal ', totalVal);

                                                        let totalRes = parseFloat(total.innerHTML)
                                                        console.log('total :totalRes', totalRes);


                                                        // if (total.innerHTML==0) {
                                                        //     console.log('walletBalance >= totalVal');
                                                        //     walletBal.innerHTML = totalVal
                                                        //     // total.innerHTML = 0
                                                        //     const codDiv = document.getElementById('codDiv')
                                                        //     const upiDiv = document.getElementById('upiDiv')
                                                        //     const couponDiv = document.getElementById('couponDiv')
                                                        //     const couponDataDiv = document.getElementById('couponDataDiv')
                                                        //     codDiv.style.display = 'none'
                                                        //     upiDiv.style.display = 'none'
                                                        //     couponDiv.style.display = 'none'
                                                        //     couponDataDiv.style.display = 'none'
                                                        //     // walletPending
                                                        // } 
                                                        // else {

                                                        console.log('subTotal > walletBal');
                                                        // total.innerHTML = totalVal - walletBalance

                                                        walletBal.innerHTML = moneyRequired
                                                        total.innerHTML -= moneyRequired

                                                        // } 
                                                        if (total.innerHTML == 0) {
                                                            console.log('walletBalance >= totalVal');
                                                            walletBal.innerHTML = totalVal
                                                            // total.innerHTML = 0
                                                            const codDiv = document.getElementById('codDiv')
                                                            const upiDiv = document.getElementById('upiDiv')
                                                            const couponDiv = document.getElementById('couponDiv')
                                                            const couponDataDiv = document.getElementById('couponDataDiv')
                                                            codDiv.style.display = 'none'
                                                            upiDiv.style.display = 'none'
                                                            couponDiv.style.display = 'none'
                                                            couponDataDiv.style.display = 'none'
                                                            // walletPending
                                                        }
                                                        walletBalanceShow.innerHTML = walletBalanceShowVal - parseInt(walletBal.innerHTML)


                                                    })
                                                    .catch(error => {
                                                        console.log('Error updating cart quantity:', error);
                                                    });

                                            } else {
                                                console.log('in else part of fetch');

                                                const walletBalanceHidden = document.getElementById('walletBalanceHidden')
                                                walletBalanceShow.innerHTML = walletBalanceHidden.value
                                                walletDiv.style.visibility = 'hidden'
                                                couponDiv.style.display = 'block'
                                                walletBal.innerHTML = 0
                                                total.innerHTML = subTotal.innerHTML
                                                codDiv.style.display = 'block'
                                                upiDiv.style.display = 'block'
                                                couponDataDiv.style.display = 'block'

                                            }
                                        });
                                    });


                                </script>
                                <div class="payment-method">
                                    <div class="payment-accordion">
                                        <div id="accordion">
                                            <div class="card">
                                                <%if(walletData && walletData!=null && walletData.balance>0){%>
                                                    <div class="categori-checkbox" id="#payment-1">
                                                        <h5 class="panel-title">
                                                            <input type="checkbox" name="wallet" value="wallet"
                                                                id="walletCheckbox">
                                                            <a class="" data-toggle="collapse" data-target="#collapseW"
                                                                aria-expanded="true" aria-controls="collapseOne">
                                                                Apply Wallet Balance
                                                            </a>
                                                        </h5>
                                                    </div>

                                                    <div id="collapseW" class="collapse show" data-parent="#accordion">
                                                        <div class="card-body">
                                                            <p>
                                                                Available Balance <strong id="walletBalanceShow">
                                                                    <%=walletData.balance%>
                                                                </strong>
                                                            </p>
                                                            <p>Apply Wallet Money To Your Order
                                                            </p>
                                                            <input type="text" value="<%=walletData.balance%>"
                                                                id="walletBalanceHidden" hidden>
                                                        </div>
                                                    </div>
                                                    <%}%>
                                                        <div id="codDiv">
                                                            <div class="card-header" id="#payment-1">
                                                                <h5 class="panel-title">
                                                                    <input checked type="radio" name="paymentMethod"
                                                                        value="cod" onchange="updateButton()">
                                                                    <a class="" data-toggle="collapse"
                                                                        data-target="#collapseOne" aria-expanded="true"
                                                                        aria-controls="collapseOne">
                                                                        Cash On Delivery
                                                                    </a>
                                                                </h5>
                                                            </div>
                                                            <div id="collapseOne" class="collapse show"
                                                                data-parent="#accordion">
                                                                <div class="card-body">
                                                                    <p>"Shop now, pay later! Enjoy the convenience of
                                                                        Cash
                                                                        on
                                                                        Delivery."
                                                                    </p>
                                                                </div>
                                                            </div>
                                                        </div>
                                            </div>
                                            <div id="upiDiv">
                                                <div class="card">
                                                    <div class="card-header" id="#payment-2">
                                                        <h5 class="panel-title">
                                                            <!-- change this value in future -->
                                                            <input type="radio" name="paymentMethod" value="upi"
                                                                onchange="updateButton()">
                                                            <a class="collapsed" data-toggle="collapse"
                                                                data-target="#collapseTwo" aria-expanded="false"
                                                                aria-controls="collapseTwo">
                                                                UPI
                                                            </a>
                                                        </h5>
                                                    </div>
                                                    <div id="collapseTwo" class="collapse" data-parent="#accordion">
                                                        <div class="card-body">
                                                            <p>"Upholding trust in every tap â€“ UPI, where security meets
                                                                simplicity."</p>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <!-- <div class="card">
                                        <div class="card-header" id="#payment-3">
                                            <h5 class="panel-title">
                                                <input type="radio" name="paymentMethod">
                                                <a class="collapsed" data-toggle="collapse" data-target="#collapseThree"
                                                    aria-expanded="false" aria-controls="collapseThree">
                                                    PayPal
                                                </a>
                                            </h5>
                                        </div>
                                        <div id="collapseThree" class="collapse" data-parent="#accordion">
                                            <div class="card-body">
                                                <p>Make your payment directly into our bank account. Please use your
                                                    Order ID as the payment reference. Your order wonâ€™t be shipped until
                                                    the funds have cleared in our account.</p>
                                            </div>
                                        </div>
                                    </div> -->
                                            <button id="rzp-button1" style="display: none;">Pay with Razorpay</button>
                                            <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
                                            <script>
                                                document.getElementById('rzp-button1').onclick = function (e) {
                                                    e.preventDefault();
                                                    var orderId;
                                                    var totalAmount;
                                                    console.log("Processing Razorpay payment...");
                                                    const total = document.getElementById('total').innerHTML
                                                    const selectedPaymentMethod = document.querySelector('input[name="paymentMethod"]:checked').value;
                                                    const indexOfUserAddress = document.querySelector('input[name="indexOfAddress"]:checked').value;

                                                    const requestData = {
                                                        totalAmount: total
                                                    };

                                                    fetch('/online-payment', {
                                                        method: 'POST',
                                                        headers: {
                                                            'Content-Type': 'application/json',
                                                        },
                                                        body: JSON.stringify(requestData)
                                                    }).then(response => response.json())
                                                        .then(data => {
                                                            console.log(data.message);
                                                            orderId = data.razorOrder
                                                            totalAmount = data.totalAmount
                                                            initializePayment(orderId, totalAmount)

                                                        })
                                                        .catch(error => {
                                                            console.log('Error updating cart quantity:', error);
                                                        });



                                                }


                                                function initializePayment(orderId, totalAmount) {
                                                    let order = JSON.stringify(orderId);
                                                    let amount = totalAmount
                                                    var options = {
                                                        "key": "rzp_test_EkB64T3dRlXXxF", // Enter the Key ID generated from the Dashboard
                                                        "amount": amount, // Amount is in currency subunits. Default currency is INR. Hence, 50000 refers to 50000 paise
                                                        "currency": "INR",
                                                        "name": "Jersy Man",
                                                        "description": "Test Transaction",
                                                        "image": "https://example.com/your_logo",
                                                        "order_id": orderId.id, //This is a sample Order ID. Pass the `id` obtained in the response of Step 1
                                                        "handler": function (response) {

                                                            let razId = orderId.id
                                                            placeOrder(razId)
                                                            // window.location.href(`/change-payment-status?razId=${razId}`)


                                                        },
                                                        "theme": {
                                                            "color": "#3399cc"
                                                        }
                                                    };
                                                    var rzp1 = new Razorpay(options);
                                                    rzp1.on('payment.failed', function (response) {
                                                        alert(response.error.code);
                                                        alert(response.error.description);
                                                        alert(response.error.source);
                                                        alert(response.error.step);
                                                        alert(response.error.reason);
                                                        alert(response.error.metadata.order_id);
                                                        alert(response.error.metadata.payment_id);
                                                    });
                                                    rzp1.open();
                                                }


                                            </script>
                                            <li id="addressErr" class="fade-out text-danger text-center"
                                                style="display: none;">
                                                please add a address before proceeding</li>
                                            <style>
                                                .fade-out {
                                                    opacity: 100;
                                                    transition: opacity 0.5s ease-out;
                                                    /* You can adjust the duration and timing function */
                                                }
                                            </style>
                                        </div>

                                        <div class="order-button-payment">
                                            <input id="paymentButton" value="Place order" type="submit"
                                                onclick="updateButton()">
                                        </div>
                                        <script>

                                            function updateButton() {
                                                var codRadio = document.querySelector('input[value="cod"]');
                                                var upiRadio = document.querySelector('input[value="upi"]');
                                                var paymentButton = document.getElementById('paymentButton');

                                                if (codRadio.checked || upiRadio.checked) {
                                                    // If Cash On Delivery is selected

                                                    paymentButton.onclick = function () {
                                                        checkAddress();
                                                    };
                                                }
                                            }

                                            //check address before proceeding
                                            const addressErr = document.getElementById('addressErr');
                                            function checkAddress() {
                                                var codRadio = document.querySelector('input[value="cod"]');
                                                var upiRadio = document.querySelector('input[value="upi"]');
                                                var paymentButton = document.getElementById('paymentButton');
                                                const amountPaid = document.getElementById('total').innerHTML
                                                const walletCheckbox = document.getElementById('walletCheckbox')



                                                const userAddressLength = <%= cartData ?cartData.userId.address.length: 0 %>;
                                                if (userAddressLength > 0) {
                                                    if (walletCheckbox.checked && amountPaid > 0) {

                                                        if (codRadio.checked) {
                                                            confirmOrder();
                                                        } else if (upiRadio.checked) {
                                                            pay()
                                                        }
                                                    } else if (walletCheckbox.checked && amountPaid <= 0) {
                                                        confirmOrder()
                                                    } else {
                                                        if (codRadio.checked) {
                                                            confirmOrder();
                                                        } else if (upiRadio.checked) {
                                                            pay()
                                                        }
                                                    }


                                                } else {
                                                    addressErr.style.display = 'block';
                                                    setTimeout(() => {
                                                        addressErr.classList.add('fade-out');

                                                        setTimeout(() => {
                                                            addressErr.style.display = 'none';
                                                            addressErr.classList.remove('fade-out');
                                                        }, 500); // Use the same duration as the transition in CSS
                                                    }, 3000);
                                                }
                                            }


                                            // if upi radio button is selected razor pay swal

                                            function pay() {
                                                Swal.fire({
                                                    title: 'Place Order?',
                                                    text: 'Do you want to place this order?',
                                                    icon: 'question',
                                                    showCancelButton: true,
                                                    confirmButtonText: 'Yes, Order!',
                                                    cancelButtonText: 'No, cancel'
                                                }).then((result) => {
                                                    if (result.value) {
                                                        document.getElementById('rzp-button1').click()
                                                    } else {
                                                        Swal.fire('Cancelled', 'Your order was not placed.', 'info');
                                                    }
                                                });

                                            }

                                            //confirm order function for placing order in cod
                                            function confirmOrder() {

                                                addressErr.style.display = 'none'



                                                Swal.fire({
                                                    title: 'Place Order?',
                                                    text: 'Do you want to place this order?',
                                                    icon: 'question',
                                                    showCancelButton: true,
                                                    confirmButtonText: 'Yes, Order!',
                                                    cancelButtonText: 'No, cancel'
                                                }).then((result) => {
                                                    if (result.value) {

                                                        placeOrder()


                                                    } else {
                                                        Swal.fire('Cancelled', 'Your order was not placed.', 'info');
                                                    }
                                                });

                                            }

                                            //use this function weather it is cod or upi

                                            function placeOrder(razId = "nill") {
                                                const walletCheckbox = document.getElementById('walletCheckbox')
                                                const couponAmount = document.getElementById('couponAmount')
                                                let walletStatus = false
                                                let couponStatus = false
                                                let moneyFromWallet = 0
                                                let moneyFromCoupon = 0
                                                let couponName = ''
                                                let couponType = ''
                                                let couponDis=0

                                                if (walletCheckbox.checked) {
                                                    walletStatus = true
                                                    moneyFromWallet = parseInt(document.getElementById('walletBal').innerHTML)
                                                }
                                                if (couponAmount.innerHTML > 0) {
                                                    couponStatus = true
                                                    moneyFromCoupon = parseInt(couponAmount.innerHTML)
                                                    couponName = document.getElementById('currentCouponNameHidden').value
                                                    couponType=document.getElementById('currentCouponTypeHidden').value
                                                    couponDis=parseInt(document.getElementById('currentCouponValueHidden').value)
                                                }


                                                const total =parseInt( document.getElementById('subTotal').innerHTML)
                                                let selectedPaymentMethod = document.querySelector('input[name="paymentMethod"]:checked').value;
                                                const indexOfUserAddress = document.querySelector('input[name="indexOfAddress"]:checked').value;
                                                const amountPaid = parseInt(document.getElementById('total').innerHTML)

                                                if (walletCheckbox.checked && amountPaid == 0) {
                                                    selectedPaymentMethod = 'wallet'
                                                }

                                                const data = {
                                                    paymentMethod: selectedPaymentMethod,
                                                    totalAmount: total,
                                                    indexOfAddress: indexOfUserAddress,
                                                    razId: razId,
                                                    amountPaid: amountPaid,
                                                    walletStatus: walletStatus,
                                                    moneyFromWallet: moneyFromWallet,
                                                    couponStatus: couponStatus,
                                                    moneyFromCoupon: moneyFromCoupon,
                                                    couponName: couponName,
                                                    couponType:couponType,
                                                    couponDiscount:couponDis,


                                                };

                                                fetch('/place-order', {
                                                    method: 'POST',
                                                    headers: {
                                                        'Content-Type': 'application/json',
                                                    },
                                                    body: JSON.stringify(data),
                                                }).then(response => response.json())
                                                    .then(data => {
                                                        console.log(data.message);

                                                        window.location.href = '/user-dashboard?goto=user+orders';



                                                    })
                                                    .catch(error => {
                                                        console.log('Error updating cart quantity:', error);
                                                    });
                                            }
                                        </script>

                                        <div class="order-button-payment">

                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <%}else{%>



                <div class="container mt-5">
                    <div class="card bg-light text-center border-0 custom-card-height p-5">
                        <h5 class="card-title mb-4">Your Cart is Empty Add Items To Your Cart</h5>
                        <p class="card-text">Please add items to your cart to proceed to checkout.</p>
                        <!-- You can customize the message and style as needed -->
                    </div>
                </div>

                <%}%>

                    <%}else{%>
                        <div class="container mt-5">
                            <div class="card bg-light text-center border-0 custom-card-height p-5">
                                <h5 class="card-title mb-4">Your Cart is Empty Add Items To Your Cart</h5>
                                <p class="card-text">Please add items to your cart to proceed to checkout.</p>
                                <!-- You can customize the message and style as needed -->
                            </div>
                        </div>
                        <%}%>

                            <style>
                                .custom-card-height {
                                    height: 300px;
                                    /* Adjust the height as per your preference */
                                }
                            </style>


                            <!-- ----------modal------------------ -->
                            <style>
                                .custom-swal-text {
                                    color: black;
                                }

                                .custom-width-button {
                                    width: 200px;
                                }

                                .custom-swal-popup {
                                    background-color: #d8ae04;
                                    /* Green */
                                    color: white;
                                }

                                .custom-swal-title {
                                    color: white;
                                }

                                .custom-swal-confirm-button {
                                    background-color: #45a049;
                                    /* Darker green */
                                    color: white;
                                }

                                .custom-swal-confirm-button,
                                .custom-swal-deny-button,
                                .custom-swal-cancel-button {
                                    background-color: #fed700;
                                    /* Custom yellow color */
                                    color: white;
                                }
                            </style>

                            <script>
                                function deleteAddress() {

                                    Swal.fire({
                                        title: 'Delete Address?',
                                        text: 'Do you want to Delete this Address?',
                                        icon: 'question',
                                        showCancelButton: true,
                                        confirmButtonText: 'Yes, Delete!',
                                        cancelButtonText: 'No, cancel'
                                    }).then((result) => {
                                        if (result.value) {
                                            const indexOfAddress = document.getElementById('indexOfAddress').value
                                            fetch(`/edit-user-address?index=${indexOfAddress}`, {
                                                method: 'DELETE',
                                                headers: {
                                                    'Content-Type': 'application/json'
                                                }
                                            }).then(response => response.json())
                                                .then(data => {
                                                    console.log(data.message)
                                                    window.location.reload();
                                                })
                                                .catch(error => console.log('cannot delete the file', error))

                                        } else {
                                            Swal.fire('Cancelled', 'Your Address was not Deleted.', 'info');
                                        }
                                    });



                                }
                            </script>







                            <!-- --------------modal----for adding product------------ -->

                            <div class="modal fade modal-wrapper" id="exampleModalCenter">
                                <div class="modal-dialog modal-dialog-centered modal-sm" role="document">
                                    <div class="modal-content  text-center">
                                        <div class="modal-body">
                                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                                <span aria-hidden="true">&times;</span>
                                            </button>
                                            <div class="checkout-area pt-60 pb-30">
                                                <div class="container">
                                                    <div class="row">
                                                        <div class="col-lg-6 col-12">
                                                            <% if (cartData && cartData!=null) { %>
                                                                <form
                                                                    action="/add-address?_id=<%=cartData.userId._id%>&from=checkout"
                                                                    class="mx-auto" id="address-form" method="post">
                                                                    <%}%>
                                                                        <div class="checkbox-form">
                                                                            <h3>Address Details</h3>
                                                                            <div class="row">
                                                                                <div class="col-md-6">
                                                                                    <div class="checkout-form-list">
                                                                                        <label>First Name <span
                                                                                                class="required">*</span></label>
                                                                                        <input placeholder="eg: Dinesh"
                                                                                            type="text" name="firstName"
                                                                                            id="firstName">
                                                                                        <li class="text-center text-danger"
                                                                                            id="firstNameErr">
                                                                                        </li>
                                                                                    </div>
                                                                                </div>
                                                                                <div class="col-md-6">
                                                                                    <div class="checkout-form-list">
                                                                                        <label>Last Name </label>
                                                                                        <input placeholder="eg: Ragav"
                                                                                            type="text" name="lastName"
                                                                                            id="lastName">

                                                                                    </div>
                                                                                </div>
                                                                                <div class="col-md-6">
                                                                                    <div class="checkout-form-list">
                                                                                        <label>Phone Number<span
                                                                                                class="required">*</span></label>
                                                                                        <input
                                                                                            placeholder="Your 10 digit phone number"
                                                                                            type="number" name="phone"
                                                                                            id="phone">
                                                                                        <li class="text-center text-danger"
                                                                                            id="phoneErr">
                                                                                        </li>
                                                                                    </div>
                                                                                </div>
                                                                                <div class="col-md-6">
                                                                                    <div class="checkout-form-list">
                                                                                        <label>Alternate Number<span
                                                                                                class="required">*</span></label>
                                                                                        <input
                                                                                            placeholder="Alternate 10 digit phone number"
                                                                                            type="number"
                                                                                            name="altPhone"
                                                                                            id="altPhone">
                                                                                        <li class="text-center text-danger"
                                                                                            id="altPhoneErr">
                                                                                        </li>
                                                                                    </div>
                                                                                </div>
                                                                                <div class="col-md-12">
                                                                                    <div class="checkout-form-list">
                                                                                        <label>House Name <span
                                                                                                class="required">*</span></label>
                                                                                        <input
                                                                                            placeholder="Your House Name"
                                                                                            type="text" name="houseName"
                                                                                            id="houseName">
                                                                                        <li class="text-center text-danger"
                                                                                            id="houseNameErr">
                                                                                        </li>
                                                                                    </div>
                                                                                </div>

                                                                                <div class="col-md-6">
                                                                                    <div class="checkout-form-list">
                                                                                        <label>City <span
                                                                                                class="required">*</span></label>
                                                                                        <input placeholder="eg: Kochi"
                                                                                            type="text" name="city"
                                                                                            id="city">
                                                                                        <li class="text-center text-danger"
                                                                                            id="cityErr">
                                                                                        </li>
                                                                                    </div>
                                                                                </div>
                                                                                <div class="col-md-6">
                                                                                    <div class="checkout-form-list">
                                                                                        <label>State <span
                                                                                                class="required">*</span></label>
                                                                                        <input placeholder="eg: Kerala"
                                                                                            type="text" name="state"
                                                                                            id="state">
                                                                                        <li class="text-center text-danger"
                                                                                            id="stateErr">
                                                                                        </li>
                                                                                    </div>
                                                                                </div>
                                                                                <div class="col-md-6">
                                                                                    <div class="checkout-form-list">
                                                                                        <label>Pincode <span
                                                                                                class="required">*</span></label>
                                                                                        <input placeholder="eg: 680664"
                                                                                            type="number" name="pincode"
                                                                                            id="pincode">
                                                                                        <li class="text-center text-danger"
                                                                                            id="pincodeErr">
                                                                                        </li>
                                                                                    </div>
                                                                                </div>
                                                                                <div class="col-md-6">
                                                                                    <div class="checkout-form-list">
                                                                                        <label>Landmark <span
                                                                                                class="required">*</span></label>
                                                                                        <input
                                                                                            placeholder="eg: Near Abu Backers"
                                                                                            type="text" name="landMark"
                                                                                            id="landMark">
                                                                                        <li class="text-center text-danger"
                                                                                            id="landMarkErr">
                                                                                        </li>
                                                                                    </div>
                                                                                </div>
                                                                                <div
                                                                                    class="col-12 d-flex justify-content-center">
                                                                                    <button
                                                                                        onclick="return validateForm()"
                                                                                        class="register-button mt-0"
                                                                                        type="button">Add</button>
                                                                                </div>

                                                                            </div>
                                                                        </div>
                                                                </form>




                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <script>
                                function validateForm() {
                                    // Define validation rules for each field
                                    var validationRules = {
                                        'firstName': 'required',
                                        'phone': 'phone',
                                        'altPhone': 'phone',
                                        'houseName': 'required',
                                        'city': 'required',
                                        'state': 'required',
                                        'pincode': 'pincode',
                                        'landMark': 'required'
                                    };

                                    // Reset error messages
                                    resetErrors();

                                    // Validate each field based on rules
                                    var hasErrors = false;
                                    for (var field in validationRules) {
                                        var rule = validationRules[field];
                                        var value = document.getElementById(field).value.trim();
                                        var errorId = field + 'Err';

                                        switch (rule) {
                                            case 'required':
                                                if (!value) {
                                                    document.getElementById(errorId).innerText = 'Please fill the field.';
                                                    hasErrors = true;
                                                }
                                                break;
                                            case 'phone':
                                                if (!isValidPhoneNumber(value)) {
                                                    document.getElementById(errorId).innerText = 'Enter a valid phone number.';
                                                    hasErrors = true;
                                                }
                                                break;
                                            case 'pincode':
                                                if (!isValidPincode(value)) {
                                                    document.getElementById(errorId).innerText = 'Enter a valid pincode.';
                                                    hasErrors = true;
                                                }
                                                break;
                                            // Add more validation rules as needed
                                        }
                                    }
                                    var phone = document.getElementById('phone').value.trim();
                                    var altPhone = document.getElementById('altPhone').value.trim();
                                    if (phone === altPhone) {
                                        document.getElementById('altPhoneErr').innerText = 'same as the phone number';
                                        hasErrors = true;
                                    }
                                    if (!hasErrors) {
                                        showConfirmationDialog();
                                    }

                                    return !hasErrors; // Prevent form submission if there are errors
                                }

                                function isValidPhoneNumber(phone) {
                                    // Implement phone number validation logic here
                                    // Return true if valid, false otherwise
                                    return /^\d{10}$/.test(phone);
                                }

                                function isValidPincode(pincode) {
                                    // Implement pincode validation logic here
                                    // Return true if valid, false otherwise
                                    return /^\d{6}$/.test(pincode);
                                }

                                function showConfirmationDialog() {
                                    Swal.fire({
                                        title: 'Add Address?',
                                        text: 'Do you want to Add this Address?',
                                        icon: 'question',
                                        showCancelButton: true,
                                        confirmButtonText: 'Yes, Add!',
                                        cancelButtonText: 'No, cancel'
                                    }).then((result) => {
                                        if (result.value) {
                                            document.getElementById('address-form').submit();
                                        } else {
                                            Swal.fire('Cancelled', 'Your Address was not added.', 'info');
                                        }
                                    });
                                }

                                function resetErrors() {
                                    var fields = ['firstName', 'phone', 'altPhone', 'houseName', 'city', 'state', 'pincode', 'landMark'];
                                    for (var i = 0; i < fields.length; i++) {
                                        var fieldName = fields[i];
                                        var errorId = fieldName + 'Err';
                                        document.getElementById(errorId).innerText = '';
                                    }
                                }
                            </script>
                            <%- include('footer.ejs') %>